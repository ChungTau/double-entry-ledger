services:
  # 1. PostgreSQL 18
  postgres:
    image: postgres:18-alpine
    container_name: ledger-postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: ledger_db
    ports:
      - "15432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ledger-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d ledger_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Redis 7
  redis:
    image: redis:7-alpine
    container_name: ledger-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes 
    networks:
      - ledger-net

  # 3. Kafka 4.0
  kafka:
    image: apache/kafka:4.0.0
    container_name: ledger-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      
      KAFKA_LISTENERS: CONTROLLER://:9093,INTERNAL://:29092,EXTERNAL://:9092
      
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092
      
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3
    networks:
      - ledger-net

  # 4. Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: ledger-kafka-ui
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    depends_on:
      - kafka
    networks:
      - ledger-net

  # 5. Elasticsearch 8.x - Audit Log Storage
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.3
    container_name: ledger-elasticsearch
    environment:
      - discovery.type=single-node
      - node.name=ledger-es-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - cluster.name=ledger-cluster
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - ledger-net
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -vq '\"status\":\"red\"'"]
      interval: 10s
      timeout: 10s
      retries: 10

  # 6. Kibana - Elasticsearch Visualization
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.3
    container_name: ledger-kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_NAME=ledger-kibana
      - XPACK_SECURITY_ENABLED=false
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - ledger-net

  # API Gateway (Go + Gin)
  gateway:
    build:
      context: ./apps/gateway
      dockerfile: Dockerfile
    container_name: ledger-gateway
    ports:
      - "8081:8081"
    environment:
      GATEWAY_PORT: "8081"
      GRPC_LEDGER_ADDR: "host.docker.internal:9098"
      REDIS_ADDR: "redis:6379"
      JWT_SECRET: "${JWT_SECRET:-dev-secret-key}"
      RATE_LIMIT_RPS: "10"
      RATE_LIMIT_BURST: "20"
      MOCK_MODE: "false"
      DEV_MODE: "true"
    depends_on:
      - redis
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ledger-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  audit-service:
    build:
      context: ./apps/audit
      dockerfile: Dockerfile
    container_name: ledger-audit
    environment:
      KAFKA_BROKER: kafka:29092
      KAFKA_TOPIC: transaction-events
      KAFKA_DLQ_TOPIC: transactions-dlq
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_INDEX: transactions
    depends_on:
      kafka:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    networks:
      - ledger-net

  # Kibana Index Pattern Auto-Configuration
  kibana-init:
    build:
      context: ./deploy/docker/kibana-init
      dockerfile: Dockerfile
    container_name: ledger-kibana-init
    environment:
      KIBANA_URL: http://kibana:5601
      MAX_RETRIES: 30
      RETRY_INTERVAL: 10
    depends_on:
      kibana:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    networks:
      - ledger-net
    restart: "no"

  # 5. Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: ledger-prometheus
    user: root
    ports:
      - "9091:9090"
    volumes:
      - ./deploy/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ledger-net
    restart: unless-stopped

  # 6. Grafana - Metrics Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: ledger-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deploy/docker/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - ledger-net
    restart: unless-stopped

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  elasticsearch_data:

networks:
  ledger-net:
    driver: bridge